#include "cmp_movement_player.h"
#include "cmp_actor_movement.h"
#include "cmp_sprite.h"
#include "cmp_bullet.h"
#include "../helper_code/Controls.h"
#include "../helper_code/Loader.h"
#include <engine.h>
#include "../game.h"
#include <iostream>
#include <SFML/Graphics.hpp>
#include <SFML/Window/Keyboard.hpp>

using namespace sf;
using namespace std;

void PlayerMovementComponent::update(double dt) {
	const auto pos = _parent->getPosition();
	float x = 0.f;
	float y = 0.f;

	if (pos.y >= Engine::getWindowSize().y + 100 || pos.x < -50) {
		_alive = false;
		_parent->setPosition(Vector2f(250, Engine::getWindowSize().y + 120));
	}
	if (!_alive && !_showGameOver) {
		_showGameOver = true;
		createGameOver();
	}

	//check position state: set if falling, jumping ect.
	_grounded = isGrounded(pos);
	updateMovement(pos, dt);

	//update jump
	if (!_jumping && !_grounded) {
		_y_acceleration = _pulse * 30 / _gravity * -1;
	}
	if (!_grounded) {
		y -= _y_acceleration;
		_y_acceleration -= _gravity * dt;
	}
	if (_grounded) {
		_jumping = false;
		x = dirX * _speed * 50 + (_platformMovement);
	}
	if (x == 0) {
		x = (dirX*_speed * 50);
	}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	move(Vector2f(x*dt, (y)));
}

void PlayerMovementComponent::setSpeed(float spd)
{
	this->_speed = spd;
}

void PlayerMovementComponent::getCollision(sf::Vector2f pos)
{
	auto playerTop = pos.y;
	auto playerBottom = pos.y + 30;	//players height
	auto playerLeft = pos.x;
	auto playerRight = pos.x + 10;	//players width

	unsigned int _playerColour = _parent->GetCompatibleComponent<ShapeComponent>()[0]->getShape().getFillColor().toInteger();

	bool grounded = false;
	bool collidable;
	//access the list of entities
	auto x = Component::_parent->scene->ents.list;

	//iteration through entities
	for (auto i = x.begin(); i != x.end(); i++) {
		auto obj = *i;
		//auto comp = obj->get_components();	
		collidable = false;
		//check tags to see if object is colidable. floors/ enemies/ platforms
		auto tags = obj->getTags();
		for (std::set<std::string>::iterator it = tags.begin(); it != tags.end(); ++it) {
			if (*it == "floor") {
				unsigned int color = obj->GetCompatibleComponent<ShapeComponent>()[0]->getShape().getFillColor().toInteger();

				if (color == _playerColour) {
					collidable = false;
				}
				else collidable = true;
			}
		}

		if (collidable && !grounded) {
			//perform the collision check
			//check y position
			//height of the platforms is static.

			//check if touching the floor
			if (playerBottom < obj->getPosition().y + -25 && playerBottom > obj->getPosition().y)
			{
				//check x position
				//TODO hardcoded size of the platform
				if (pos.x > obj->getPosition().x &&  pos.x < obj->getPosition().x + 150) {
					_jumping = false;
				}
				else {
				}
			}

			//check if touches the ceiling 
			if (playerTop > obj->getPosition().y + 20 && playerTop < obj->getPosition().y + 55)
			{
				//check x position
				//TODO hardcoded size of the platform
				if (pos.x > obj->getPosition().x &&  pos.x < obj->getPosition().x + 150) {
					_jumping = false;
				}
			}
		}
		if (collidable) {
			//right
			if (obj->getPosition().y > pos.y - 30 && obj->getPosition().y < pos.y + 30) {
				if (pos.x + 5 > obj->getPosition().x - 5 && pos.x < obj->getPosition().x + 5) {
					_mvRight = false;
				}
				else {
					_mvRight = true;
				}
			}
			else {
				_mvRight = true;
			}

			//left
			if (obj->getPosition().y > pos.y - 30 && obj->getPosition().y < pos.y + 30) {
				if (pos.x + 5 > obj->getPosition().x + 155 && pos.x < obj->getPosition().x + 160) {
					_mvLeft = false;
				}
				else {
					_mvLeft = true;
				}
			}
			else {
				_mvLeft = true;
			}
		}
	}
}

float PlayerMovementComponent::getYPosition(float y)
{
	return 0.f;
}

void PlayerMovementComponent::updateJump()
{

}

void PlayerMovementComponent::loadEntites()
{
	//get a pointer to the entities 
	Component::_parent->scene->ents;
}

bool PlayerMovementComponent::isGrounded(sf::Vector2f pos)
{
	auto playerTop = pos.y;
	auto playerBottom = pos.y - 2;	//players height
	auto playerLeft = pos.x;
	auto playerRight = pos.x + 10;	//players width
	unsigned int playerColour = _parent->GetCompatibleComponent<ShapeComponent>()[0]->getShape().getFillColor().toInteger();
	bool grounded;
	bool collidable;
	_platformMovement = 0;	//reset the platfrom movement

	//access and iterate through the list of entities
	auto x = Component::_parent->scene->ents.list;
	for (auto i = x.begin(); i != x.end(); i++) {
		auto obj = *i;
		collidable = false;	//reset flag
		//check tags to see if object is colidable. floors/ enemies/ platforms
		auto tags = obj->getTags();
		for (std::set<std::string>::iterator it = tags.begin(); it != tags.end(); ++it) {
			if (*it == "floor") {
				//check if the colours are the same,
				unsigned int color = obj->GetCompatibleComponent<ShapeComponent>()[0]->getShape().getFillColor().toInteger();
				if (color == playerColour) {
					collidable = false;
				}
				else collidable = true;
			}
		}
		if (collidable) {
			//perform the collision check
			//check y position
			if (playerBottom > obj->getPosition().y - 20 && playerBottom < obj->getPosition().y + 15)
			{
				//check x position
				if (pos.x > obj->getPosition().x - 5 && pos.x < obj->getPosition().x + 155) {
					//player is confirmed to be drounded, get the x movement of the platform
					auto objSpeed = obj->GetCompatibleComponent<ActorMovementComponent>()[0]->getSpeed();
					this->_platformMovement = objSpeed;
					return true;
				}
			}
			else {
				grounded = false;
			}
		}
		else {
			grounded = false;
		}
	}
	return grounded;
}

void PlayerMovementComponent::updateMovement(sf::Vector2f pos, double dt)
{
	//check collision
	if (Keyboard::isKeyPressed(Controls::GetKey("Left")) ||
		Keyboard::isKeyPressed(Controls::GetKey("Right"))) {
		// Moving Either Left or Right
		//check collision everytime a buyttoin is pressed

		if (Keyboard::isKeyPressed(Controls::GetKey("Right")) && _mvRight) {
			getCollision(pos);
			if (_mvRight) {
				dirX = 1;
			}
			else {
				dirX = 0;
			}
		}
		else if (Keyboard::isKeyPressed(Controls::GetKey("Left")) && _mvLeft) {
			getCollision(pos);
			if (_mvLeft) {
				dirX = -1;
			}
			else {
				dirX = 0;
			}
		}
	}
	else {
		dirX = 0;
	}

	//jump behaviour
	if (Keyboard::isKeyPressed(Controls::GetKey("Jump"))) {
		getCollision(pos);
		if (_grounded) {
			_y_acceleration = 0;
			_grounded = false;
			_jumping = true;
			_y_acceleration += _pulse;
		}
	}
	if (_alive) {
		if (Keyboard::isKeyPressed(Controls::GetKey("Red"))) {
			//red
			auto s = _parent->GetCompatibleComponent<ShapeComponent>()[0];
			s->getShape().setFillColor(Color::Red);
			_sndColChange.play();
		}

		if (Keyboard::isKeyPressed(Controls::GetKey("Green"))) {
			//green
			auto s = _parent->GetCompatibleComponent<ShapeComponent>()[0];
			s->getShape().setFillColor(Color::Green);
			_sndColChange.play();
		}

		if (Keyboard::isKeyPressed(Controls::GetKey("Blue"))) {
			//blue
			auto s = _parent->GetCompatibleComponent<ShapeComponent>()[0];
			s->getShape().setFillColor(Color::Blue);
			_sndColChange.play();
		}
	}
	if (Keyboard::isKeyPressed(Controls::GetKey("Shoot")) && !_firePressed) {
		//reset functionality when game over 
		if (_showGameOver == true) {
			_showGameOver = false;
			Engine::GetActiveScene()->state_reset = true;
		}
		else {
			fireBullet(pos);
			_sndShoot.play();
			_firePressed = true;
		}

	}
	if (!Keyboard::isKeyPressed(Controls::GetKey("Shoot"))) {
		_firePressed = false;
	}
	if (Keyboard::isKeyPressed(Controls::GetKey("Return")) && _showGameOver) {
		Engine::GetActiveScene()->state_menu = true;
		return;
	}
}

void PlayerMovementComponent::setDead()
{
	_alive = false;
}


bool PlayerMovementComponent::validMove(const sf::Vector2f& pos) {
	return true;
}

void PlayerMovementComponent::move(const sf::Vector2f& p) {
	auto pp = _parent->getPosition() + p;
	_parent->setPosition(pp);
}

void PlayerMovementComponent::move(float x, float y) {
	move(Vector2f(x, y));
}

void PlayerMovementComponent::fireBullet(sf::Vector2f pos) {
	createPlayerBullet(_parent->getPosition(), _parent->GetCompatibleComponent<ShapeComponent>()[0]->getShape().getFillColor());
}

PlayerMovementComponent::PlayerMovementComponent(Entity* p)
	: _speed(10.f), Component(p) {

	dirX = 0;
	dirY = 0;
	_platformMovement;
	falling = 1;
	_speed = 10.f;

	//collision swiches
	_grounded = false;
	_jumping = true;
	_mvLeft = true;
	_mvRight = true;
	_firePressed = false;
	_alive = true;
	_showGameOver = false;

	_pulse = 27.0f;
	_y_acceleration = 0.f;

	//sounds
	_loadShoot = *(Resources::get<SoundBuffer>("fire.wav"));
	_loadcolChange = *(Resources::get<SoundBuffer>("colorChange.wav"));
	_sndShoot.setBuffer(_loadShoot);
	_sndColChange.setBuffer(_loadcolChange);

}


